name: CD Workflow

on:
  push:
    branches:
      - main

# MODIFIED: Required for Azure OIDC login (no SP secret stored in GitHub)
permissions:
  id-token: write   # MODIFIED
  contents: read    # MODIFIED

jobs:
  cd-deploy-test:
    name: Deploy to TEST
    runs-on: ubuntu-latest
    environment: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4   # MODIFIED (v3 -> v4)

      - name: Setup Python
        uses: actions/setup-python@v5  # MODIFIED (v4 -> v5)
        with:
          python-version: '3.11'

      - name: Install Databricks CLI
        run: curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install setuptools wheel

      # MODIFIED: Login to Azure using OIDC (no AZURE_CLIENT_SECRET in GitHub)
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}          # MODIFIED (secrets -> vars)
          tenant-id: ${{ vars.AZURE_TENANT_ID }}          # MODIFIED (secrets -> vars)
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}  # MODIFIED (secrets -> vars)

      # MODIFIED: Pull the SP client secret from Key Vault at runtime
      - name: Read secrets from Key Vault
        uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ vars.KEY_VAULT_NAME }}            # MODIFIED (dynamic via env var/Environment var)
          secrets: |
            skylink_svc_principal_secret

      - name: Configure Databricks
        run: |
          # write out the profile (here called "TEST")
          cat <<EOF > ~/.databrickscfg
          [TEST]
          host = https://adb-7405614336867548.8.azuredatabricks.net
          azure_tenant_id = ${{ vars.AZURE_TENANT_ID }}   # MODIFIED (secrets -> vars)
          azure_client_id = ${{ vars.AZURE_CLIENT_ID }}   # MODIFIED (secrets -> vars)
          azure_client_secret = ${{ env.SKYLINK_SVC_PRINCIPAL_SECRET }}
          EOF

      - name: Deploy to TEST
        run: |
          databricks bundle deploy \
            --target test \
            --profile TEST

  cd-deploy-prod:
    name: Deploy to PROD
    needs: cd-deploy-test
    runs-on: ubuntu-latest
    environment: prd
    steps:
      - name: Checkout code
        uses: actions/checkout@v4   # MODIFIED (v3 -> v4)

      - name: Setup Python
        uses: actions/setup-python@v5  # MODIFIED (v4 -> v5)
        with:
          python-version: '3.11'

      - name: Install Databricks CLI
        run: curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install setuptools wheel

      # MODIFIED: Login to Azure using OIDC
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}          # MODIFIED
          tenant-id: ${{ vars.AZURE_TENANT_ID }}          # MODIFIED
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}  # MODIFIED

      # MODIFIED: Pull the SP client secret from Key Vault at runtime
      - name: Read secrets from Key Vault
        uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ vars.KEY_VAULT_NAME }}            # MODIFIED
          secrets: |
            ${{ vars.AZURE_CLIENT_SECRET_NAME }} 

      - name: Configure Databricks
        run: |
          # write out the profile (here called "PROD")
          cat <<EOF > ~/.databrickscfg
          [PROD]
          host = https://adb-7405610128763595.15.azuredatabricks.net
          azure_tenant_id = ${{ vars.AZURE_TENANT_ID }}   # MODIFIED
          azure_client_id = ${{ vars.AZURE_CLIENT_ID }}   # MODIFIED
          azure_client_secret = ${{ env.AZURE_CLIENT_SECRET_NAME }}
          EOF

      - name: Deploy to PROD
        run: |
          databricks bundle deploy \
            --target prod \
            --profile PROD
