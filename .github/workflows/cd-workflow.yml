name: CD Workflow

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs: 
  cd-deploy-test: 
    name: Deploy to TEST
    runs-on: ubuntu-latest
    environment: test
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Databricks CLI
        run: curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install setuptools wheel

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with: 
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      # FIX: Get the secret from Key Vault
      - name: Read secrets from Key Vault
        uses: Azure/get-keyvault-secrets@v1
        with:
          keyvault: ${{ vars. KEY_VAULT_NAME }}
          secrets: skylink-svc-principal-secret  # ✅ Use HYPHENS (Key Vault naming)

      - name: Configure Databricks
        run: |
          cat <<EOF > ~/.databrickscfg
          [TEST]
          host = https://adb-7405609017722464.4.azuredatabricks.net
          azure_tenant_id = ${{ vars.AZURE_TENANT_ID }}
          azure_client_id = ${{ vars.AZURE_CLIENT_ID }}
          azure_client_secret = ${{ env.SKYLINK-SVC-PRINCIPAL-SECRET }}
          EOF
          #                      ✅ Use UPPERCASE with HYPHENS (env var format)

      - name: Deploy to TEST
        run: |
          databricks bundle deploy \
            --target test \
            --profile TEST

  cd-deploy-prod: 
    name: Deploy to PROD
    needs: cd-deploy-test
    runs-on: ubuntu-latest
    environment: prd
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses:  actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Databricks CLI
        run: curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install setuptools wheel

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars. AZURE_CLIENT_ID }}
          tenant-id: ${{ vars. AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      # FIX: Get the secret from Key Vault
      - name: Read secrets from Key Vault
        uses: Azure/get-keyvault-secrets@v1
        with: 
          keyvault: ${{ vars.KEY_VAULT_NAME }}
          secrets: skylink-svc-principal-secret  # ✅ Use HYPHENS (Key Vault naming)

      - name: Configure Databricks
        run: |
          cat <<EOF > ~/.databrickscfg
          [PROD]
          host = https://adb-7405613130773209.9.azuredatabricks.net
          azure_tenant_id = ${{ vars.AZURE_TENANT_ID }}
          azure_client_id = ${{ vars.AZURE_CLIENT_ID }}
          azure_client_secret = ${{ env.SKYLINK-SVC-PRINCIPAL-SECRET }}
          EOF
          #                      ✅ Use UPPERCASE with HYPHENS (env var format)

      - name: Deploy to PROD
        run: |
          databricks bundle deploy \
            --target prod \
            --profile PROD
